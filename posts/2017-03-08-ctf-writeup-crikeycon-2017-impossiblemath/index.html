<!doctype html><html lang=en-au><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Understanding Integer Overflows - CrikeyCon 2017, Impossible Math Writeup | Codingo - Ethical Hacking and Bug Bounty Advice</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Category: Coding Points: 400 Solves: 7 Description: ctf.crikeycon.com:43981 Enumeration Before doing anything else on the host since we were provided with an unual port and address I attempted to ncat to it, receiving the following:
Identifying the core problem Since the math is impossible there’s likely a trick here. With that in mind I figure we need to overload an operator (integer overflow) and try passing a large number as input:"><meta name=generator content="Hugo 0.82.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/styles/main.min.5aa989ccece6768a55775df4de57e25997dae78933c82cea38f8239a8789c9f7.css integrity="sha256-WqmJzOzmdopVd1303lfiWZfa54kzyCzqOPgjmoeJyfc="><meta property="og:title" content="Understanding Integer Overflows - CrikeyCon 2017, Impossible Math Writeup"><meta property="og:description" content="Category: Coding Points: 400 Solves: 7 Description: ctf.crikeycon.com:43981 Enumeration Before doing anything else on the host since we were provided with an unual port and address I attempted to ncat to it, receiving the following:
Identifying the core problem Since the math is impossible there’s likely a trick here. With that in mind I figure we need to overload an operator (integer overflow) and try passing a large number as input:"><meta property="og:type" content="article"><meta property="og:url" content="https://codingo.com/posts/2017-03-08-ctf-writeup-crikeycon-2017-impossiblemath/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-03-08T17:10:58+10:00"><meta property="article:modified_time" content="2017-03-08T17:10:58+10:00"><meta itemprop=name content="Understanding Integer Overflows - CrikeyCon 2017, Impossible Math Writeup"><meta itemprop=description content="Category: Coding Points: 400 Solves: 7 Description: ctf.crikeycon.com:43981 Enumeration Before doing anything else on the host since we were provided with an unual port and address I attempted to ncat to it, receiving the following:
Identifying the core problem Since the math is impossible there’s likely a trick here. With that in mind I figure we need to overload an operator (integer overflow) and try passing a large number as input:"><meta itemprop=datePublished content="2017-03-08T17:10:58+10:00"><meta itemprop=dateModified content="2017-03-08T17:10:58+10:00"><meta itemprop=wordCount content="851"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Understanding Integer Overflows - CrikeyCon 2017, Impossible Math Writeup"><meta name=twitter:description content="Category: Coding Points: 400 Solves: 7 Description: ctf.crikeycon.com:43981 Enumeration Before doing anything else on the host since we were provided with an unual port and address I attempted to ncat to it, receiving the following:
Identifying the core problem Since the math is impossible there’s likely a trick here. With that in mind I figure we need to overload an operator (integer overflow) and try passing a large number as input:"></head><body class="font-sans text-white antialiased bg-black text-light"><div class="py-16 bg-dark"></div><header class="sticky top-0 bg-dark z-10"><nav class="main-navigation content-container" role=navigation><div class="flex items-center"><a class=video-logo-compact-container href=/ class=flex-none><video id=video-logo-compact preload=true autoplay muted>
<source src=/video/codingo-logo-compact.webm type=video/webm><img src=/images/codingo-logo-lockup.png alt><br></video></a><div class=flex-grow></div><div class="flex-none relative navigation-menu"><div class="cursor-pointer hamburger"><svg class="fill-current text-green-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4A1 1 0 013 5zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/></svg></div><div class="menu-list absolute bg-secondary p-2 right-0 hidden"><ul class="divide-y divide-red-400"><li><a class="py-4 px-8 block cursor-pointer" href=https://youtube.com/codingo title=Videos>Videos</a></li><li><a class="py-4 px-8 block cursor-pointer" href=https://chat.codingo.com title=Forum>Forum</a></li><li><a class="py-4 px-8 block cursor-pointer" href=https://codingo.com/posts title=Blog>Blog</a></li></ul></div></div></div></nav></header><div class="py-4 bg-dark"></div><div id="content z-10 relative"><article class="content-container pt-20"><header><aside>POSTS</aside><h1>Understanding Integer Overflows - CrikeyCon 2017, Impossible Math Writeup</h1><div class="mb-12 mt-2"><img class="inline-block mr-2 -mt-1 icon-calendar" src=/images/icon-feather-calendar.png alt srcset>
<date class="inline-block mr-6">Mar 8, 2017</date><div class=inline-block><span class="border-b border-secondary mr-2 whitespace-nowrap">4 minutes read</span>
<span class="border-b border-secondary whitespace-nowrap">851 words</span></div></div></header><div class=markdown><pre><code>Category: Coding
Points: 400
Solves: 7
Description:  ctf.crikeycon.com:43981
</code></pre><h1 id=enumeration>Enumeration</h1><p>Before doing anything else on the host since we were provided with an unual port and address I attempted to ncat to it, receiving the following:</p><p><img src=/images/integer-overflows/ImpossibleMath-Preview.png alt="Impossible Math Preview"></p><h1 id=identifying-the-core-problem>Identifying the core problem</h1><p>Since the math is impossible there’s likely a trick here. With that in mind I figure we need to overload an operator (integer overflow) and try passing a large number as input:</p><p><img src=/images/integer-overflows/OverflowCheck.png alt="Impossible Math Overflow Check"></p><p>Awesome! Our integer overloads by wrapping around. To gather a bit more information I also tried an integer underflow:</p><p><img src=/images/integer-overflows/UnderflowCheck.png alt="Impossible Math Underflow Check"></p><p>The same result. I now had to identify the figure we wrap around. These numbers are a bit irritatingly long to work with so I tried something a bit smaller to see if I could something more manageable:</p><p><img src=/images/integer-overflows/ManageableNumbers.png alt="Impossible Math Manageable Numbers"></p><p>We can use the following to identify our overflow point:</p><p><img src=/images/integer-overflows/OverflowFormula.png alt="Impossible Math Manageable Numbers"></p><p>4294967296 is exactly 2^32, which is 1 beyond the maximum supported by unsigned int (32 bits), further supporting our case that this is an integer overflow exercise.</p><p>To validate this, I should be able to pass this value to any problem and receive 0 back as a response (as it will reach the signed amount and loop back once), as follows:</p><p><img src=/images/integer-overflows/ZeroTest.png alt="Impossible Math Manageable Numbers"></p><p>For the remainder of this exercise I’m going to refer to the variables from our second-last screenshot as the following:</p><p><img src=/images/integer-overflows/Variables.png alt="Impossible Math Manageable Numbers"></p><p>Since our number wraparounds we now know we need a number with the following conditions:</p><ul><li>Our overflow must be lower than 4294967296 but higher than our destination to pass the first condition.</li><li>Our overflow needs to exceed 4294967296 when multiplied by the multiplier and result in the destination</li></ul><h1 id=calculating-the-correct-overflow>Calculating the correct overflow</h1><p>As a reminder, we can calculate our overflow using the formula from earlier:</p><p><img src=/images/integer-overflows/VerboseVariables.png alt="Impossible Math Formula"></p><p>I turned this into a proof of concept by generating a new ncat session, which asked the following:</p><pre><code>Solve for X, where:
X &gt; 37864
X * 8 = 37864
</code></pre><p>To generate our answer, I used the following:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>python <span style=color:#f92672>-</span>c <span style=color:#e6db74>&#39;print((2**32+destination)/multiplier)&#39;</span>
</code></pre></div><p>This generated the answer of 536875645 as follows:</p><p><img src=/images/integer-overflows/FirstAnswer.png alt="Impossible Math First Answer"></p><p>Under some circumstances, we would then be able to pipe our answer into a new ncat session but since our variables change on each connection we need to do this manually to verify it’s correct:</p><p><img src=/images/integer-overflows/FirstFlag.png alt="Impossible Math First Flag"></p><p>Success! Our flag was revealed.</p><h1 id=creating-an-automatic-answer-tool>Creating an automatic answer tool</h1><p>Manual answers are great, but this is classified as a coding challenge, not a mathematical one!</p><p>There are a few core processes to this part of the exercise. First is forming an open connection and identifying our destination and multiplier from the data that comes back. We’ve also been asked in the banner of our connection to limit our calculations to 4 bytes, so we’ll make sure we limit what we request at a time.</p><p>Splitting our variables out of the calculation is quite easy. They’re both present on the line reflected as:</p><p><img src=/images/integer-overflows/SecondCheck.png alt="Impossible Math Second Check"></p><p>We can use regular expressions to identify this packet stream from the equals sign, and then split our values out into capture groups using another expression. Putting this boilerplate together looks like the following:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e>#!/usr/bin/python3</span>
 
<span style=color:#f92672>import</span> socket
<span style=color:#f92672>import</span> re
<span style=color:#f92672>import</span> operator
<span style=color:#f92672>import</span> sys

MAXBUF <span style=color:#f92672>=</span> <span style=color:#ae81ff>4096</span>
SENTINEL <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;flag&#39;</span>
CTF_BOT <span style=color:#f92672>=</span> (<span style=color:#e6db74>&#39;ctf.crikeycon.com&#39;</span>, <span style=color:#ae81ff>43981</span>)


<span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
    client <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>socket(socket<span style=color:#f92672>.</span>AF_INET, socket<span style=color:#f92672>.</span>SOCK_STREAM)
    client<span style=color:#f92672>.</span>connect(CTF_BOT)

    <span style=color:#66d9ef>while</span> True:
        data <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;&#39;</span>

        <span style=color:#75715e># receive and store data</span>
        <span style=color:#66d9ef>while</span> True:
            chunk <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>recv(MAXBUF)
            data <span style=color:#f92672>+=</span> chunk
            <span style=color:#66d9ef>if</span> len(chunk) <span style=color:#f92672>&lt;</span> MAXBUF:
                <span style=color:#66d9ef>break</span>
        
        <span style=color:#75715e># store decoded data for future usage</span>
        decoded <span style=color:#f92672>=</span> data<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)
        
        <span style=color:#75715e># print out response packet</span>
        <span style=color:#66d9ef>print</span>(decoded)

        <span style=color:#75715e># our flag contains flag{}, once it&#39;s revealed print received data and exit</span>
        <span style=color:#66d9ef>if</span> SENTINEL <span style=color:#f92672>in</span> decoded:
            <span style=color:#66d9ef>break</span>

        <span style=color:#75715e># skip loop until we see our X * Y = Z line</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> re<span style=color:#f92672>.</span>search(<span style=color:#e6db74>&#39;[=]&#39;</span>, decoded):
            <span style=color:#66d9ef>continue</span>

        <span style=color:#75715e># select integers and store into capture groups</span>
        match <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>search(<span style=color:#e6db74>&#39;(\d+) = (\d+)&#39;</span>, decoded)
   
        <span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;multiplier: &#39;</span> <span style=color:#f92672>+</span> match<span style=color:#f92672>.</span>group(<span style=color:#ae81ff>1</span>))
        <span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;destination: &#39;</span> <span style=color:#f92672>+</span> match<span style=color:#f92672>.</span>group(<span style=color:#ae81ff>2</span>))
</code></pre></div><p><img src=/images/integer-overflows/BoilerPlateExec.png alt="Impossible Math Boilerplate Execution"></p><p>Great! We now have what we need in a variable. Referring back to our formula above, we now need to calculate:</p><p><img src=/images/integer-overflows/VerboseVariables.png alt="Impossible Math Formula"></p><p>This will look like the following (note that we cast our regular expressions back to integers to prevent operand exceptions):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>multiplier <span style=color:#f92672>=</span> int(match<span style=color:#f92672>.</span>group(<span style=color:#ae81ff>1</span>))
destination <span style=color:#f92672>=</span> int(match<span style=color:#f92672>.</span>group(<span style=color:#ae81ff>2</span>))
overflow <span style=color:#f92672>=</span> int((<span style=color:#ae81ff>2</span><span style=color:#f92672>**</span><span style=color:#ae81ff>32</span><span style=color:#f92672>+</span>destination) <span style=color:#f92672>/</span> multiplier)
</code></pre></div><h1 id=final-script>Final Script</h1><p>Putting it all together we receive the following:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e>#!/usr/bin/python3</span>
 
<span style=color:#f92672>import</span> socket
<span style=color:#f92672>import</span> re
<span style=color:#f92672>import</span> operator
<span style=color:#f92672>import</span> sys

MAXBUF <span style=color:#f92672>=</span> <span style=color:#ae81ff>4096</span>
SENTINEL <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;flag&#39;</span>
CTF_BOT <span style=color:#f92672>=</span> (<span style=color:#e6db74>&#39;ctf.crikeycon.com&#39;</span>, <span style=color:#ae81ff>43981</span>)


<span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
    client <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>socket(socket<span style=color:#f92672>.</span>AF_INET, socket<span style=color:#f92672>.</span>SOCK_STREAM)
    client<span style=color:#f92672>.</span>connect(CTF_BOT)

    <span style=color:#66d9ef>while</span> True:
        data <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;&#39;</span>

        <span style=color:#75715e># receive and store data</span>
        <span style=color:#66d9ef>while</span> True:
            chunk <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>recv(MAXBUF)
            data <span style=color:#f92672>+=</span> chunk
            <span style=color:#66d9ef>if</span> len(chunk) <span style=color:#f92672>&lt;</span> MAXBUF:
                <span style=color:#66d9ef>break</span>
        
        <span style=color:#75715e># store decoded data for future usage</span>
        decoded <span style=color:#f92672>=</span> data<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)
        
        <span style=color:#75715e># print out response packet</span>
        <span style=color:#66d9ef>print</span>(decoded)

        <span style=color:#75715e># our flag contains flag{}, once it&#39;s revealed print recevied data and exit</span>
        <span style=color:#66d9ef>if</span> SENTINEL <span style=color:#f92672>in</span> decoded:
            <span style=color:#66d9ef>break</span>

        <span style=color:#75715e># skip loop until we see our X * Y = Z line</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> re<span style=color:#f92672>.</span>search(<span style=color:#e6db74>&#39;[=]&#39;</span>, decoded):
            <span style=color:#66d9ef>continue</span>

        <span style=color:#75715e># select integers and store into capture groups</span>
        match <span style=color:#f92672>=</span> re<span style=color:#f92672>.</span>search(<span style=color:#e6db74>&#39;(\d+) = (\d+)&#39;</span>, decoded)
   
        multiplier <span style=color:#f92672>=</span> int(match<span style=color:#f92672>.</span>group(<span style=color:#ae81ff>1</span>))
        destination <span style=color:#f92672>=</span> int(match<span style=color:#f92672>.</span>group(<span style=color:#ae81ff>2</span>))
        overflow <span style=color:#f92672>=</span> int((<span style=color:#ae81ff>2</span><span style=color:#f92672>**</span><span style=color:#ae81ff>32</span><span style=color:#f92672>+</span>destination) <span style=color:#f92672>/</span> multiplier)
        
        <span style=color:#75715e># encode and transfer</span>
        client<span style=color:#f92672>.</span>send(str(overflow)<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)<span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)
</code></pre></div><p><img src=/images/integer-overflows/flag.png alt="Impossible Math Flag"></p><p>Success!</p><p>I hope this helped you to better understand integer overflows. If you&rsquo;re Brisbane based, or find yourself here be sure to check out <a href=https://www.meetup.com/en-AU/SecTalks-Brisbane/>SecTalks</a>.</p><ul class=pa0></ul><div class="mt6 instapaper_ignoref"><div id=discourse-comments></div><script type=text/javascript>DiscourseEmbed={discourseUrl:'https://chat.codingo.com/',discourseEmbedUrl:"https://codingo.com/posts/2017-03-08-ctf-writeup-crikeycon-2017-impossiblemath/"},function(){var a=document.createElement('script');a.type='text/javascript',a.async=!0,a.src=DiscourseEmbed.discourseUrl+'javascripts/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)}()</script></div></div><aside class="w-30-l mt6-l"></aside></article></div><script src=https://codingo.com/js/fss.min.js></script><script src=https://codingo.com/js/codingo.js></script></body></html>