<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Understanding Integer Overflows - CrikeyCon 2017, Impossible Math Writeup | Codingo - Ethical Hacking and Bug Bounty Advice</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Category: Coding Points: 400 Solves: 7 Description: ctf.crikeycon.com:43981 Enumeration Before doing anything else on the host since we were provided with an unual port and address I attempted to ncat to it, receiving the following:
Identifying the core problem Since the math is impossible there’s likely a trick here. With that in mind I figure we need to overload an operator (integer overflow) and try passing a large number as input:"><meta name=generator content="Hugo 0.81.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/codingo/dist/main.css_5c99d70a7725bacd4c701e995b969fea.css><link rel=stylesheet href=https://codingo.com/codingo/scss/style.43da1d60ebc47e233a67f808b2b66c8b106884cee9e9c65f98e0facad4eb00e5.css><meta property="og:title" content="Understanding Integer Overflows - CrikeyCon 2017, Impossible Math Writeup"><meta property="og:description" content="Category: Coding Points: 400 Solves: 7 Description: ctf.crikeycon.com:43981 Enumeration Before doing anything else on the host since we were provided with an unual port and address I attempted to ncat to it, receiving the following:
Identifying the core problem Since the math is impossible there’s likely a trick here. With that in mind I figure we need to overload an operator (integer overflow) and try passing a large number as input:"><meta property="og:type" content="article"><meta property="og:url" content="https://codingo.com/posts/2017-03-08-ctf-writeup-crikeycon-2017-impossiblemath/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-03-08T17:10:58+10:00"><meta property="article:modified_time" content="2017-03-08T17:10:58+10:00"><meta itemprop=name content="Understanding Integer Overflows - CrikeyCon 2017, Impossible Math Writeup"><meta itemprop=description content="Category: Coding Points: 400 Solves: 7 Description: ctf.crikeycon.com:43981 Enumeration Before doing anything else on the host since we were provided with an unual port and address I attempted to ncat to it, receiving the following:
Identifying the core problem Since the math is impossible there’s likely a trick here. With that in mind I figure we need to overload an operator (integer overflow) and try passing a large number as input:"><meta itemprop=datePublished content="2017-03-08T17:10:58+10:00"><meta itemprop=dateModified content="2017-03-08T17:10:58+10:00"><meta itemprop=wordCount content="886"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Understanding Integer Overflows - CrikeyCon 2017, Impossible Math Writeup"><meta name=twitter:description content="Category: Coding Points: 400 Solves: 7 Description: ctf.crikeycon.com:43981 Enumeration Before doing anything else on the host since we were provided with an unual port and address I attempted to ncat to it, receiving the following:
Identifying the core problem Since the math is impossible there’s likely a trick here. With that in mind I figure we need to overload an operator (integer overflow) and try passing a large number as input:"></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib"><img src=/images/codingo-logo-lockup.png alt=CODINGO></a><div class="flex-l items-center"></div></div></nav></div></header><main class="pb7 bg-black" role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class=mt3><a href="https://www.facebook.com/sharer.php?u=https://codingo.com/posts/2017-03-08-ctf-writeup-crikeycon-2017-impossiblemath/" class="facebook no-underline" aria-label="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></a><a href="https://twitter.com/share?url=https://codingo.com/posts/2017-03-08-ctf-writeup-crikeycon-2017-impossiblemath/&text=Understanding%20Integer%20Overflows%20-%20CrikeyCon%202017,%20Impossible%20Math%20Writeup" class="twitter no-underline" aria-label="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://codingo.com/posts/2017-03-08-ctf-writeup-crikeycon-2017-impossiblemath/&title=Understanding%20Integer%20Overflows%20-%20CrikeyCon%202017,%20Impossible%20Math%20Writeup" class="linkedin no-underline" aria-label="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></a></div><h1 class="f1 athelas mt3 mb1">Understanding Integer Overflows - CrikeyCon 2017, Impossible Math Writeup</h1><time class="f6 mv4 dib tracked" datetime=2017-03-08T17:10:58+10:00>March 8, 2017</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><pre><code>Category: Coding
Points: 400
Solves: 7
Description:  ctf.crikeycon.com:43981
</code></pre><h1 id=enumeration>Enumeration</h1><p>Before doing anything else on the host since we were provided with an unual port and address I attempted to ncat to it, receiving the following:</p><p><img src=/images/integer-overflows/ImpossibleMath-Preview.png alt="Impossible Math Preview"></p><h1 id=identifying-the-core-problem>Identifying the core problem</h1><p>Since the math is impossible there’s likely a trick here. With that in mind I figure we need to overload an operator (integer overflow) and try passing a large number as input:</p><p><img src=/images/integer-overflows/OverflowCheck.png alt="Impossible Math Overflow Check"></p><p>Awesome! Our integer overloads by wrapping around. To gather a bit more information I also tried an integer underflow:</p><p><img src=/images/integer-overflows/UnderflowCheck.png alt="Impossible Math Underflow Check"></p><p>The same result. I now had to identify the figure we wrap around. These numbers are a bit irritatingly long to work with so I tried something a bit smaller to see if I could something more manageable:</p><p><img src=/images/integer-overflows/ManageableNumbers.png alt="Impossible Math Manageable Numbers"></p><p>We can use the following to identify our overflow point:</p><p><img src=/images/integer-overflows/OverflowFormula.png alt="Impossible Math Manageable Numbers"></p><p>4294967296 is exactly 2^32, which is 1 beyond the maximum supported by unsigned int (32 bits), further supporting our case that this is an integer overflow exercise.</p><p>To validate this, I should be able to pass this value to any problem and receive 0 back as a response (as it will reach the signed amount and loop back once), as follows:</p><p><img src=/images/integer-overflows/ZeroTest.png alt="Impossible Math Manageable Numbers"></p><p>For the remainder of this exercise I’m going to refer to the variables from our second-last screenshot as the following:</p><p><img src=/images/integer-overflows/Variables.png alt="Impossible Math Manageable Numbers"></p><p>Since our number wraparounds we now know we need a number with the following conditions:</p><ul><li>Our overflow must be lower than 4294967296 but higher than our destination to pass the first condition.</li><li>Our overflow needs to exceed 4294967296 when multiplied by the multiplier and result in the destination</li></ul><h1 id=calculating-the-correct-overflow>Calculating the correct overflow</h1><p>As a reminder, we can calculate our overflow using the formula from earlier:</p><p><img src=/images/integer-overflows/VerboseVariables.png alt="Impossible Math Formula"></p><p>I turned this into a proof of concept by generating a new ncat session, which asked the following:</p><p>{% highlight text %}
Solve for X, where:
X > 37864
X * 8 = 37864
{% endhighlight %}</p><p>To generate our answer, I used the following:</p><p>{% highlight python %}
python -c &lsquo;print((2**32+destination)/multiplier)&rsquo;
{% endhighlight %}</p><p>This generated the answer of 536875645 as follows:</p><p><img src=/images/integer-overflows/FirstAnswer.png alt="Impossible Math First Answer"></p><p>Under some circumstances, we would then be able to pipe our answer into a new ncat session but since our variables change on each connection we need to do this manually to verify it’s correct:</p><p><img src=/images/integer-overflows/FirstFlag.png alt="Impossible Math First Flag"></p><p>Success! Our flag was revealed.</p><h1 id=creating-an-automatic-answer-tool>Creating an automatic answer tool</h1><p>Manual answers are great, but this is classified as a coding challenge, not a mathematical one!</p><p>There are a few core processes to this part of the exercise. First is forming an open connection and identifying our destination and multiplier from the data that comes back. We’ve also been asked in the banner of our connection to limit our calculations to 4 bytes, so we’ll make sure we limit what we request at a time.</p><p>Splitting our variables out of the calculation is quite easy. They’re both present on the line reflected as:</p><p><img src=/images/integer-overflows/SecondCheck.png alt="Impossible Math Second Check"></p><p>We can use regular expressions to identify this packet stream from the equals sign, and then split our values out into capture groups using another expression. Putting this boilerplate together looks like the following:</p><p>{% highlight python %}
#!/usr/bin/python3</p><p>import socket
import re
import operator
import sys</p><p>MAXBUF = 4096
SENTINEL = &lsquo;flag&rsquo;
CTF_BOT = (&lsquo;ctf.crikeycon.com&rsquo;, 43981)</p><p>if <strong>name</strong> == &lsquo;<strong>main</strong>':
client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
client.connect(CTF_BOT)</p><pre><code>while True:
    data = b''

    # receive and store data
    while True:
        chunk = client.recv(MAXBUF)
        data += chunk
        if len(chunk) &lt; MAXBUF:
            break
    
    # store decoded data for future usage
    decoded = data.decode('utf-8')
    
    # print out response packet
    print(decoded)

    # our flag contains flag{}, once it's revealed print received data and exit
    if SENTINEL in decoded:
        break

    # skip loop until we see our X * Y = Z line
    if not re.search('[=]', decoded):
        continue

    # select integers and store into capture groups
    match = re.search('(\d+) = (\d+)', decoded)

    print('multiplier: ' + match.group(1))
    print('destination: ' + match.group(2))
</code></pre><p>{% endhighlight %}</p><p><img src=/images/integer-overflows/BoilerPlateExec.png alt="Impossible Math Boilerplate Execution"></p><p>Great! We now have what we need in a variable. Referring back to our formula above, we now need to calculate:</p><p><img src=/images/integer-overflows/VerboseVariables.png alt="Impossible Math Formula"></p><p>This will look like the following (note that we cast our regular expressions back to integers to prevent operand exceptions):</p><p>{% highlight python %}
multiplier = int(match.group(1))
destination = int(match.group(2))
overflow = int((2**32+destination) / multiplier)
{% endhighlight %}</p><h1 id=final-script>Final Script</h1><p>Putting it all together we receive the following:</p><p>{% highlight python %}
#!/usr/bin/python3</p><p>import socket
import re
import operator
import sys</p><p>MAXBUF = 4096
SENTINEL = &lsquo;flag&rsquo;
CTF_BOT = (&lsquo;ctf.crikeycon.com&rsquo;, 43981)</p><p>if <strong>name</strong> == &lsquo;<strong>main</strong>':
client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
client.connect(CTF_BOT)</p><pre><code>while True:
    data = b''

    # receive and store data
    while True:
        chunk = client.recv(MAXBUF)
        data += chunk
        if len(chunk) &lt; MAXBUF:
            break
    
    # store decoded data for future usage
    decoded = data.decode('utf-8')
    
    # print out response packet
    print(decoded)

    # our flag contains flag{}, once it's revealed print recevied data and exit
    if SENTINEL in decoded:
        break

    # skip loop until we see our X * Y = Z line
    if not re.search('[=]', decoded):
        continue

    # select integers and store into capture groups
    match = re.search('(\d+) = (\d+)', decoded)

    multiplier = int(match.group(1))
    destination = int(match.group(2))
    overflow = int((2**32+destination) / multiplier)
    
    # encode and transfer
    client.send(str(overflow).encode('utf-8')+ b'\n')
</code></pre><p>{% endhighlight %}</p><p><img src=/images/integer-overflows/flag.png alt="Impossible Math Flag"></p><p>Success!</p><p>I hope this helped you to better understand integer overflows. If you&rsquo;re Brisbane based, or find yourself here be sure to check out <a href=https://www.meetup.com/en-AU/SecTalks-Brisbane/>SecTalks</a>.</p><ul class=pa0></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://codingo.com/>&copy; Codingo - Ethical Hacking and Bug Bounty Advice 2021</a><div></div></div></footer><script src=https://codingo.com/codingo/js/fss.min.js></script><script src=https://codingo.com/codingo/js/codingo.js></script></body></html>